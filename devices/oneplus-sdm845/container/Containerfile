ARG from
FROM $from

ARG target_tag

COPY etc/ /etc/
COPY usr/ /usr/

# kernel
RUN mkdir /boot/dtb && \
    dnf -y remove kernel && \
    dnf -y install kernel kernel-modules-extra && \
    rm -rf /boot/dtb

# firmware
RUN dnf -y install \
    bcm283x-firmware \
    qcom-firmware

# qualcomm tools and libs
RUN dnf -y install \
    libssc \
    hexagonrpc \
    pil-squasher \
    tqftpserv \
    pd-mapper \
    rmtfs \
    qrtr \
    qbootctl \
    bootmac

RUN systemctl enable \
    tqftpserv.service \
    rmtfs.service

# audio
RUN dnf -y install \
    alsa-utils \
    pipewire \
    pipewire-alsa \
    pipewire-pulseaudio \
    alsa-ucm-mobility-sdm845 \
    q6voiced

RUN systemctl enable q6voiced.service

RUN systemctl mask \
    alsa-state.service \
    alsa-restore.service

# usb network
RUN dnf -y install \
    dnsmasq

# other
RUN dnf -y install \
    ath10k-shutdown \
    mobility-tweaks \
    buffyboard

RUN systemctl enable \
    qbootctl.service \
    bootmac-bluetooth.service \
    hexagonrpcd-sdsp.service \
    msm-modem-uim-selection.service

COPY fwload/usr/ /usr/

COPY usbnet/etc/ /etc/
COPY usbnet/usr/ /usr/

# cleanup
RUN dnf clean all && rm -rf /var/log/*

RUN bootc container lint --no-truncate
